<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ðŸ“Š Business Intelligence - Agentic AI System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .bi-header {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            color: white;
            margin-bottom: 30px;
        }
        
        .dashboard-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.1);
            padding: 25px;
            margin-bottom: 25px;
            transition: all 0.3s ease;
        }
        
        .dashboard-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
        }
        
        .kpi-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }
        
        .kpi-card:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }
        
        .kpi-value {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .kpi-label {
            font-size: 1rem;
            opacity: 0.9;
        }
        
        .trend-up {
            color: #28a745;
        }
        
        .trend-down {
            color: #dc3545;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            margin: 20px 0;
        }
        
        .insight-item {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 5px;
        }
        
        .report-card {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .report-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.3);
        }
        
        .alert-card {
            background: #fff3cd;
            border: 1px solid #ffecb5;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .btn-generate {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            color: white;
            border-radius: 25px;
            padding: 12px 25px;
            transition: all 0.3s ease;
        }
        
        .btn-generate:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
            color: white;
        }
        
        .metric-badge {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            border-radius: 20px;
            padding: 5px 15px;
            font-size: 12px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container-fluid p-4">
        <!-- Header -->
        <div class="bi-header">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1><i class="fas fa-chart-line"></i> Business Intelligence Dashboard</h1>
                    <p class="mb-0">AI-powered insights and predictive analytics for your agentic system</p>
                </div>
                <div class="col-md-4 text-end">
                    <button class="btn btn-light me-2" onclick="generateReport()">
                        <i class="fas fa-file-download"></i> Generate Report
                    </button>
                    <button class="btn btn-outline-light" onclick="refreshData()">
                        <i class="fas fa-sync"></i> Refresh
                    </button>
                </div>
            </div>
        </div>

        <!-- KPI Row -->
        <div class="row mb-4">
            <div class="col-md-2">
                <div class="kpi-card">
                    <div class="kpi-value" id="totalWorkflows">-</div>
                    <div class="kpi-label">Total Workflows</div>
                    <small class="trend-up"><i class="fas fa-arrow-up"></i> +12%</small>
                </div>
            </div>
            <div class="col-md-2">
                <div class="kpi-card">
                    <div class="kpi-value" id="activeAgents">-</div>
                    <div class="kpi-label">Active Agents</div>
                    <small class="trend-up"><i class="fas fa-arrow-up"></i> +8%</small>
                </div>
            </div>
            <div class="col-md-2">
                <div class="kpi-card">
                    <div class="kpi-value" id="monthlyExecutions">-</div>
                    <div class="kpi-label">Monthly Executions</div>
                    <small class="trend-up"><i class="fas fa-arrow-up"></i> +25%</small>
                </div>
            </div>
            <div class="col-md-2">
                <div class="kpi-card">
                    <div class="kpi-value" id="successRate">-</div>
                    <div class="kpi-label">Success Rate</div>
                    <small class="trend-up"><i class="fas fa-arrow-up"></i> +2%</small>
                </div>
            </div>
            <div class="col-md-2">
                <div class="kpi-card">
                    <div class="kpi-value" id="avgResponseTime">-</div>
                    <div class="kpi-label">Avg Response</div>
                    <small class="trend-down"><i class="fas fa-arrow-down"></i> -15%</small>
                </div>
            </div>
            <div class="col-md-2">
                <div class="kpi-card">
                    <div class="kpi-value" id="costSavings">-</div>
                    <div class="kpi-label">Cost Savings</div>
                    <small class="trend-up"><i class="fas fa-arrow-up"></i> +40%</small>
                </div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="row">
            <div class="col-md-8">
                <div class="dashboard-card">
                    <h5><i class="fas fa-chart-area"></i> Usage Trends</h5>
                    <div class="chart-container">
                        <canvas id="usageChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="dashboard-card">
                    <h5><i class="fas fa-robot"></i> Top Performing Agents</h5>
                    <div class="chart-container">
                        <canvas id="agentChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Performance & Cost Analysis -->
        <div class="row">
            <div class="col-md-6">
                <div class="dashboard-card">
                    <h5><i class="fas fa-tachometer-alt"></i> Agent Performance Metrics</h5>
                    <div id="agentPerformance">
                        <!-- Performance metrics will be loaded here -->
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="dashboard-card">
                    <h5><i class="fas fa-dollar-sign"></i> Cost Analytics</h5>
                    <div class="chart-container">
                        <canvas id="costChart"></canvas>
                    </div>
                    <div class="mt-3">
                        <div class="d-flex justify-content-between mb-2">
                            <span>LLM7 (Free)</span>
                            <span class="metric-badge">$0.00</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>OpenRouter</span>
                            <span class="metric-badge">$45.20</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>OpenAI</span>
                            <span class="metric-badge">$80.30</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Insights & Reports -->
        <div class="row">
            <div class="col-md-8">
                <div class="dashboard-card">
                    <h5><i class="fas fa-lightbulb"></i> AI-Powered Insights</h5>
                    <div id="predictiveInsights">
                        <!-- Insights will be loaded here -->
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="dashboard-card">
                    <h5><i class="fas fa-file-alt"></i> Automated Reports</h5>
                    
                    <div class="report-card" onclick="generateSpecificReport('performance')">
                        <h6><i class="fas fa-chart-line"></i> Performance Report</h6>
                        <small>Weekly agent performance analysis</small>
                    </div>
                    
                    <div class="report-card" onclick="generateSpecificReport('cost')">
                        <h6><i class="fas fa-money-bill-wave"></i> Cost Analysis</h6>
                        <small>Monthly cost breakdown and optimization</small>
                    </div>
                    
                    <div class="report-card" onclick="generateSpecificReport('usage')">
                        <h6><i class="fas fa-users"></i> Usage Analytics</h6>
                        <small>User behavior and system utilization</small>
                    </div>
                    
                    <button class="btn btn-generate w-100 mt-3" data-bs-toggle="modal" data-bs-target="#customReportModal">
                        <i class="fas fa-plus"></i> Create Custom Report
                    </button>
                </div>
            </div>
        </div>

        <!-- System Alerts -->
        <div class="row">
            <div class="col-12">
                <div class="dashboard-card">
                    <h5><i class="fas fa-exclamation-triangle"></i> System Alerts & Recommendations</h5>
                    <div id="systemAlerts">
                        <!-- Alerts will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Report Modal -->
    <div class="modal fade" id="customReportModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white;">
                    <h5 class="modal-title"><i class="fas fa-chart-bar"></i> Create Custom Report</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="customReportForm">
                        <div class="mb-3">
                            <label class="form-label">Report Type</label>
                            <select class="form-control" name="type" required>
                                <option value="">Select Type</option>
                                <option value="performance">Performance Analysis</option>
                                <option value="cost">Cost Analysis</option>
                                <option value="usage">Usage Analytics</option>
                                <option value="security">Security Audit</option>
                                <option value="custom">Custom Analysis</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Time Range</label>
                            <select class="form-control" name="time_range" required>
                                <option value="1d">Last 24 Hours</option>
                                <option value="7d" selected>Last 7 Days</option>
                                <option value="30d">Last 30 Days</option>
                                <option value="90d">Last 3 Months</option>
                                <option value="1y">Last Year</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Output Format</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="format" value="pdf" checked>
                                <label class="form-check-label">PDF Report</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="format" value="csv">
                                <label class="form-check-label">CSV Data</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="format" value="json">
                                <label class="form-check-label">JSON Export</label>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Email Recipients (Optional)</label>
                            <input type="email" class="form-control" name="recipients" placeholder="admin@company.com">
                            <small class="form-text text-muted">Separate multiple emails with commas</small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-generate" onclick="createCustomReport()">
                        <i class="fas fa-chart-bar"></i> Generate Report
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let dashboardData = {};
        let charts = {};

        // Load dashboard data on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboardData();
            initializeCharts();
        });

        async function loadDashboardData() {
            try {
                const response = await fetch('/api/business-intelligence/dashboard');
                const data = await response.json();
                
                if (data.success) {
                    dashboardData = data.data;
                    updateKPIs();
                    updateCharts();
                    updateInsights();
                    updateAlerts();
                    updateAgentPerformance();
                }
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                showNotification('Error loading dashboard data', 'error');
            }
        }

        function updateKPIs() {
            const kpis = dashboardData.kpis;
            if (kpis) {
                document.getElementById('totalWorkflows').textContent = kpis.total_workflows;
                document.getElementById('activeAgents').textContent = kpis.active_agents;
                document.getElementById('monthlyExecutions').textContent = kpis.monthly_executions.toLocaleString();
                document.getElementById('successRate').textContent = kpis.success_rate + '%';
                document.getElementById('avgResponseTime').textContent = kpis.avg_response_time;
                document.getElementById('costSavings').textContent = kpis.cost_savings;
            }
        }

        function initializeCharts() {
            // Usage Trends Chart
            const usageCtx = document.getElementById('usageChart').getContext('2d');
            charts.usage = new Chart(usageCtx, {
                type: 'line',
                data: {
                    labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                    datasets: [{
                        label: 'Daily Requests',
                        data: [],
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            // Agent Performance Chart
            const agentCtx = document.getElementById('agentChart').getContext('2d');
            charts.agent = new Chart(agentCtx, {
                type: 'doughnut',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: [
                            '#667eea',
                            '#764ba2',
                            '#28a745',
                            '#ffc107',
                            '#dc3545'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });

            // Cost Analysis Chart
            const costCtx = document.getElementById('costChart').getContext('2d');
            charts.cost = new Chart(costCtx, {
                type: 'bar',
                data: {
                    labels: ['Jan', 'Feb', 'Mar'],
                    datasets: [{
                        label: 'Monthly Cost ($)',
                        data: [],
                        backgroundColor: 'rgba(102, 126, 234, 0.7)',
                        borderColor: '#667eea',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value;
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateCharts() {
            if (dashboardData.usage_trends) {
                const trends = dashboardData.usage_trends;
                
                // Update usage chart
                charts.usage.data.datasets[0].data = trends.daily_requests;
                charts.usage.update();
                
                // Update agent chart
                charts.agent.data.labels = trends.top_agents.map(a => a.name);
                charts.agent.data.datasets[0].data = trends.top_agents.map(a => a.usage);
                charts.agent.update();
            }
            
            if (dashboardData.cost_analytics) {
                const cost = dashboardData.cost_analytics;
                
                // Update cost chart
                charts.cost.data.datasets[0].data = cost.cost_trend.map(c => c.cost);
                charts.cost.update();
            }
        }

        function updateInsights() {
            const insights = dashboardData.predictive_insights;
            if (insights) {
                const container = document.getElementById('predictiveInsights');
                
                let html = `
                    <div class="insight-item">
                        <h6><i class="fas fa-chart-line"></i> Growth Prediction</h6>
                        <p>Expected system growth: <strong>${insights.expected_growth}</strong></p>
                    </div>
                `;
                
                insights.optimization_suggestions.forEach(suggestion => {
                    html += `
                        <div class="insight-item">
                            <h6><i class="fas fa-lightbulb"></i> Optimization Suggestion</h6>
                            <p>${suggestion}</p>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
            }
        }

        function updateAlerts() {
            const insights = dashboardData.predictive_insights;
            if (insights && insights.risk_factors) {
                const container = document.getElementById('systemAlerts');
                
                let html = '';
                insights.risk_factors.forEach(risk => {
                    html += `
                        <div class="alert-card">
                            <i class="fas fa-exclamation-triangle text-warning"></i>
                            <strong>Risk Factor:</strong> ${risk}
                        </div>
                    `;
                });
                
                container.innerHTML = html;
            }
        }

        function updateAgentPerformance() {
            const performance = dashboardData.agent_performance;
            if (performance) {
                const container = document.getElementById('agentPerformance');
                
                let html = '';
                performance.slice(0, 5).forEach(agent => {
                    const successRate = agent.success_rate || 95;
                    const responseTime = agent.avg_response_time || 1.5;
                    
                    html += `
                        <div class="d-flex justify-content-between align-items-center mb-3 p-3 border rounded">
                            <div>
                                <h6 class="mb-1">${agent.agent_id}</h6>
                                <small class="text-muted">Total tasks: ${agent.total_tasks || 100}</small>
                            </div>
                            <div class="text-end">
                                <div class="metric-badge mb-1">${successRate}% success</div>
                                <small class="text-muted">${responseTime}s avg</small>
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
            }
        }

        async function generateReport() {
            try {
                showNotification('Generating comprehensive report...', 'info');
                
                const response = await fetch('/api/business-intelligence/reports/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        type: 'comprehensive',
                        time_range: '7d',
                        format: 'pdf'
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('Report generated successfully!', 'success');
                    // In a real implementation, this would download the report
                    console.log('Report data:', data.data);
                } else {
                    showNotification('Error generating report', 'error');
                }
            } catch (error) {
                console.error('Error generating report:', error);
                showNotification('Error generating report', 'error');
            }
        }

        async function generateSpecificReport(type) {
            try {
                showNotification(`Generating ${type} report...`, 'info');
                
                const response = await fetch('/api/business-intelligence/reports/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        type: type,
                        time_range: '7d',
                        format: 'pdf'
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification(`${type} report generated successfully!`, 'success');
                } else {
                    showNotification('Error generating report', 'error');
                }
            } catch (error) {
                console.error('Error generating report:', error);
                showNotification('Error generating report', 'error');
            }
        }

        async function createCustomReport() {
            const form = document.getElementById('customReportForm');
            const formData = new FormData(form);
            
            const reportData = {
                type: formData.get('type'),
                time_range: formData.get('time_range'),
                format: formData.get('format'),
                recipients: formData.get('recipients')
            };
            
            try {
                showNotification('Creating custom report...', 'info');
                
                const response = await fetch('/api/business-intelligence/reports/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(reportData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('Custom report created successfully!', 'success');
                    
                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('customReportModal'));
                    modal.hide();
                    form.reset();
                } else {
                    showNotification('Error creating report', 'error');
                }
            } catch (error) {
                console.error('Error creating report:', error);
                showNotification('Error creating report', 'error');
            }
        }

        function refreshData() {
            showNotification('Refreshing dashboard data...', 'info');
            loadDashboardData();
        }

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show position-fixed`;
            notification.style.top = '20px';
            notification.style.right = '20px';
            notification.style.zIndex = '9999';
            notification.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 4000);
        }

        // Auto-refresh every 5 minutes
        setInterval(loadDashboardData, 5 * 60 * 1000);
    </script>
</body>
</html>